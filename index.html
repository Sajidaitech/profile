<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ai image Generator</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body{font-family:'Inter',sans-serif;background-color:#f7f7f7;}
.container-card{background-color:white;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);}
.loading-ring{display:inline-block;width:80px;height:80px;}
.loading-ring:after{content:" ";display:block;width:64px;height:64px;margin:8px;border-radius:50%;border:6px solid #4ade80;border-color:#4ade80 transparent #4ade80 transparent;animation:loading-ring 1.2s linear infinite;}
@keyframes loading-ring{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

<div id="app" class="w-full max-w-4xl container-card rounded-xl p-6 md:p-10 my-4">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">ðŸŽ¬ Generate your Ai Image from your Prompt</h1>
  <p class="text-gray-600 mb-6">Describe your village video shot and generate multiple AI-visualized scenes.</p>

  <!-- Prompt + Copy -->
  <div class="mb-6 relative">
    <label for="prompt-input" class="block text-lg font-semibold text-gray-700 mb-2">Scene Description Prompt:</label>
    <textarea id="prompt-input" rows="4"
      class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition"
      placeholder="Example: A farmer guiding oxen through sunrise fields.">Write Your Prompt Here </textarea>
    <button id="copy-prompt"
      class="absolute top-2 right-2 px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600 transition">Copy</button>
  </div>

  <!-- Controls -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 mb-6">
    <div class="flex items-center mb-3 sm:mb-0">
      <label for="image-count" class="font-semibold text-gray-700 mr-2">Images:</label>
      <select id="image-count" class="border-2 border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
      </select>
    </div>
    <button id="generate-button"
      class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition transform hover:scale-[1.01] w-full sm:w-auto">
      Generate Scene Images
    </button>
  </div>

  <!-- Loading & Status -->
  <div id="status-area" class="mt-6" aria-live="polite">
    <div id="loading-indicator" class="hidden flex flex-col items-center justify-center py-10">
      <div class="loading-ring"></div>
      <p class="mt-4 text-green-600 font-medium">Generating your scenes... this may take a moment.</p>
    </div>
    <div id="message-box" class="hidden p-4 rounded-lg"></div>
  </div>

  <!-- Image Gallery -->
  <div id="image-output" class="mt-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Visualized Scenes</h2>
    <div id="carousel" class="relative flex items-center justify-center min-h-64 bg-gray-100 rounded-lg overflow-hidden border-4 border-dashed border-gray-300">
      <button id="prev-btn"
        class="absolute left-3 bg-gray-800 text-white rounded-full p-2 opacity-75 hover:opacity-100 focus:outline-none hidden">
        â—€
      </button>
      <img id="generated-image" class="w-full h-auto object-contain object-center max-h-[80vh]"
        src="https://placehold.co/800x450/e5e7eb/4b5563?text=Your+Scene+Visualization+Will+Appear+Here"
        alt="Placeholder for generated images">
      <button id="next-btn"
        class="absolute right-3 bg-gray-800 text-white rounded-full p-2 opacity-75 hover:opacity-100 focus:outline-none hidden">
        â–¶
      </button>
    </div>
    <p id="image-counter" class="text-center text-gray-600 mt-2 hidden"></p>
  </div>
</div>

<script type="module">
const apiKey = "AIzaSyBLp5r_iRRP3kxmx1O8yZcumwJ77yDkVFA"; // supply securely
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict";

const promptInput = document.getElementById('prompt-input');
const imageCountSelect = document.getElementById('image-count');
const generateButton = document.getElementById('generate-button');
const copyPromptButton = document.getElementById('copy-prompt');
const loadingIndicator = document.getElementById('loading-indicator');
const messageBox = document.getElementById('message-box');
const generatedImage = document.getElementById('generated-image');
const imageOutput = document.getElementById('image-output');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const imageCounter = document.getElementById('image-counter');

let imageList = [];
let currentIndex = 0;

async function fetchWithExponentialBackoff(url, options, maxRetries = 5, delay = 1000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url, options);
      if (response.status !== 429) return response;
      console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
    } catch (err) {
      if (i === maxRetries - 1) throw err;
    }
    await new Promise(r => setTimeout(r, delay));
    delay *= 2;
  }
  throw new Error("Failed after multiple retries");
}

function showMessage(msg, isError = false) {
  if (!msg) return messageBox.classList.add('hidden');
  messageBox.textContent = msg;
  messageBox.classList.remove('hidden');
  messageBox.className = isError
    ? "p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg"
    : "p-4 bg-green-100 text-green-700 border border-green-300 rounded-lg";
}

function updateCarousel() {
  if (!imageList.length) return;
  generatedImage.src = imageList[currentIndex];
  imageCounter.textContent = `Image ${currentIndex + 1} of ${imageList.length}`;
  imageCounter.classList.remove('hidden');
  prevBtn.classList.toggle('hidden', currentIndex === 0);
  nextBtn.classList.toggle('hidden', currentIndex === imageList.length - 1);
}

generateButton.addEventListener('click', async () => {
  const prompt = promptInput.value.trim();
  if (!prompt) return showMessage("Please enter a scene description prompt.", true);
  const count = parseInt(imageCountSelect.value);

  // UI state
  generateButton.disabled = true;
  loadingIndicator.classList.remove('hidden');
  showMessage("", false);
  generatedImage.src = 'https://placehold.co/800x450/e5e7eb/4b5563?text=Generating...';
  prevBtn.classList.add('hidden');
  nextBtn.classList.add('hidden');
  imageCounter.classList.add('hidden');

  try {
    const payload = {
      instances: [{ prompt }],
      parameters: { sampleCount: count, outputMimeType: "image/jpeg", aspectRatio: "16:9" }
    };

    const res = await fetchWithExponentialBackoff(`${API_URL}?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (!res.ok) throw new Error(result.error?.message || 'Unknown server error');

    const preds = result?.predictions || [];
    imageList = preds.map(p => `data:image/jpeg;base64,${p.bytesBase64Encoded}`).filter(Boolean);
    if (!imageList.length) throw new Error("No image data returned.");

    currentIndex = 0;
    updateCarousel();
    showMessage(`Generated ${imageList.length} image${imageList.length>1?'s':''} successfully!`, false);
    imageOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (err) {
    console.error(err);
    generatedImage.src = 'https://placehold.co/800x450/e5e7eb/ef4444/ffffff?text=Error+Loading+Images';
    showMessage("Image generation failed: " + err.message, true);
  } finally {
    generateButton.disabled = false;
    loadingIndicator.classList.add('hidden');
  }
});

prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateCarousel(); } });
nextBtn.addEventListener('click', () => { if (currentIndex < imageList.length - 1) { currentIndex++; updateCarousel(); } });

copyPromptButton.addEventListener('click', () => {
  const text = promptInput.value.trim();
  if (!text) return showMessage("Nothing to copy!", true);
  navigator.clipboard.writeText(text)
    .then(() => showMessage("Prompt copied!", false))
    .catch(() => showMessage("Copy failed.", true));
});
</script>

</body>
</html>
